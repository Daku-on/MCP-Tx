# MCP-Tx 要件定義書

## 1. プロジェクト概要

### 1.1 背景
Model Context Protocol (MCP)は、LLMが外部ツールやデータソースと通信するためのJSON-RPC 2.0ベースのプロトコルである。MCPは基本的なエラー処理とタイムアウト機能を提供しているが、エージェントの自律的なタスク実行に必要な信頼性保証が不足している。

#### MCPの現状と制限
公式Python SDKの実装調査により、以下の制限が確認されている：

**実装済みの機能：**
- リクエストレベルのタイムアウト (`read_timeout_seconds`)
- 基本的なエラー処理 (`McpError`, `CONNECTION_CLOSED`)
- JSON-RPC IDによるリクエスト-レスポンスの対応付け
- プログレス通知とキャンセル機能

**未実装の機能（MCP-Txで解決すべき課題）：**
- 自動再送機能：ネットワークエラー時の自動リトライなし
- 接続管理：長期接続維持や自動再接続なし
- メッセージ永続化：未送信メッセージの保持機能なし
- 冗長性：単一接続に依存する設計
- 冪等性保証：重複実行防止の仕組みなし
- 明示的なACK/NACK機構：メッセージの到達確認なし
- ツール状態管理：ツール別の負荷制限や競合検出なし

### 1.2 目的
MCP-Txは、MCPの上位レイヤーとして、エージェントと外部ツール間の通信に対して**ツール呼び出しに最適化された信頼性保証**を提供することを目的とする。

### 1.3 スコープ
- **対象**: Agent ↔ Tool間の通信
- **範囲**: 通信の信頼性保証、再送制御、状態追跡
- **非対象**: Agent ↔ Agent間の通信（A2Aプロトコルの範囲）

## 2. 機能要件

### 2.1 冪等性保証（Idempotency）
- **要件ID**: FR-001
- **説明**: ツール呼び出しの冪等性を保証し、重複実行を防止する
- **詳細**:
  - 各リクエストに一意のリクエストIDを付与
  - 冪等性キーによる重複リクエストの検出と排除
  - 安全な再送処理（副作用の防止）
  - 読み取り操作の重複実行許可、書き込み操作の重複防止

### 2.2 確認応答（ACK/NACK）
- **要件ID**: FR-002
- **説明**: すべてのリクエストに対して明示的な確認応答を要求する
- **詳細**:
  - 成功時：ACK（Acknowledgment）を返送
  - 失敗時：NACK（Negative Acknowledgment）を返送
  - タイムアウト時間の設定可能

### 2.3 自動再送制御
- **要件ID**: FR-003
- **説明**: 失敗やタイムアウト時の自動再送機能を提供する
- **詳細**:
  - 再送回数の上限設定
  - 再送間隔の設定（指数バックオフ対応）
  - 再送ポリシーのカスタマイズ機能

### 2.4 トランザクション管理
- **要件ID**: FR-004
- **説明**: 各操作にトランザクションIDを付与し、完了状態を追跡する
- **詳細**:
  - UUID形式のトランザクションID生成
  - トランザクションの状態遷移管理（開始、処理中、成功、失敗、タイムアウト）
  - トランザクションログの保持

### 2.5 フロー制御
- **要件ID**: FR-005
- **説明**: リソース制限に応じた送信レート制御を行う
- **詳細**:
  - トークン数制限への対応
  - API呼び出し回数制限への対応
  - 動的なレート調整機能

### 2.6 状態レポート
- **要件ID**: FR-006
- **説明**: エージェントが実行結果を確実に把握できる仕組みを提供する
- **詳細**:
  - 最終ステータスオブジェクトの返却
  - 詳細なエラー情報の提供
  - 実行履歴の照会機能

### 2.7 エラー処理
- **要件ID**: FR-007
- **説明**: 体系的なエラー処理とリカバリー機能を提供する
- **詳細**:
  - エラーコードの標準化（MCP-Tx固有のエラーコード体系）
  - エラーの分類（一時的エラー、永続的エラー、ビジネスエラー）
  - エラー時の自動リカバリー戦略
  - カスタムエラーハンドラーの登録機能

### 2.8 ヘルスチェック
- **要件ID**: FR-008
- **説明**: システムの健全性を監視するためのヘルスチェック機能を提供する
- **詳細**:
  - 定期的なヘルスチェックエンドポイント
  - コンポーネント別の健全性ステータス
  - 自動フェイルオーバーのトリガー機能
  - ヘルスメトリクスの収集と報告

## 3. 非機能要件

### 3.1 性能要件
- **要件ID**: NFR-001
- **レイテンシ**: MCPの基本レイテンシに対して+10%以内のオーバーヘッド
- **スループット**: 1秒あたり1000リクエスト以上の処理能力
- **並行性**: 最大100の同時トランザクション処理

### 3.2 信頼性要件
- **要件ID**: NFR-002
- **可用性**: 99.9%以上
- **データ整合性**: トランザクションの不整合率0.01%以下
- **障害回復**: 自動フェイルオーバー機能

### 3.3 セキュリティ要件
- **要件ID**: NFR-003
- **認証**: MCPの認証機構との互換性維持
- **暗号化**: TLS 1.3以上のサポート
- **監査**: すべてのトランザクションの監査ログ生成

### 3.4 互換性要件
- **要件ID**: NFR-004
- **MCP互換性**: 既存のMCP実装との後方互換性維持
- **段階的移行**: MCP-Txの機能を選択的に有効化可能
- **プロトコルバージョニング**: バージョン管理とネゴシエーション機能

### 3.5 データサイズ制限と大ファイル処理
- **要件ID**: NFR-005
- **メッセージサイズ**: 単一メッセージの最大サイズ: 100MB（base64後）
- **base64拡張**: MCPのbase64エンコーディングによる33%のサイズ増加を考慮
- **チャンク転送**: 10MB以上のデータに対するチャンク分割転送
- **ストリーミング**: 大容量ファイル用のストリーミング転送サポート
- **メモリ効率**: ファイル全体をメモリに読み込まない効率的な処理

## 4. インターフェース仕様

### 4.1 MCPとの統合アプローチ

MCP-TxはMCPの既存機能とシームレスに統合される：

#### MCPの`experimental`フィールドを活用
```typescript
interface ClientCapabilities {
  experimental?: {
    mcp_tx?: {
      version: string;
      features: string[];  // ["sequencing", "ack", "retry", "transactions"]
    };
  };
}
```

#### MCPの`_meta`フィールドを活用
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "file_reader",
    "arguments": {...},
    "_meta": {
      "mcp_tx": {
        "sequence": 42,
        "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
        "retry_count": 0,
        "timeout": 30000
      }
    }
  },
  "id": "mcp-request-id-123"
}
```

### 4.3 MCPエラー処理システムとの統合
- MCPの既存エラーコード体系を拡張
- MCP-Txエラーを`_meta.mcp_tx.error`フィールドで提供
- MCPの`CONNECTION_CLOSED`、`INVALID_PARAMS`等との連携

### 4.4 確認応答フォーマット
```json
{
  "jsonrpc": "2.0",
  "result": {...},
  "id": "original-request-id",
  "mcp_tx": {
    "ack": true,
    "sequence": 42,
    "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "completed",
    "timestamp": "2024-01-01T12:00:00Z"
  }
}
```

### 4.3 エラーレスポンスフォーマット
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32001,
    "message": "MCP-Tx Protocol Error",
    "data": {
      "mcp_tx_error_code": "MCP_TX_SEQUENCE_ERROR",
      "severity": "error",
      "retryable": false,
      "details": "Sequence number 43 expected, but received 45"
    }
  },
  "id": "original-request-id",
  "mcp_tx": {
    "ack": false,
    "sequence": 45,
    "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "failed"
  }
}
```

### 4.4 ヘルスチェックエンドポイント
```json
{
  "jsonrpc": "2.0",
  "method": "mcp_tx.health",
  "params": {
    "include_details": true
  },
  "id": "health-check-1"
}
```

## 5. 実装計画

### 5.1 フェーズ1: コア機能実装（1-2ヶ月）
- シーケンス番号管理
- 基本的なACK/NACK機能
- シンプルな再送制御

### 5.2 フェーズ2: 高度な機能実装（2-3ヶ月）
- トランザクション管理
- フロー制御
- 監視・ロギング機能

### 5.3 フェーズ3: 統合とテスト（1-2ヶ月）
- 既存MCPサーバーとの統合テスト
- パフォーマンステスト
- セキュリティ監査

### 5.4 フェーズ4: プロトコルバージョニング実装（1ヶ月）
- バージョンネゴシエーション機能
- 下位互換性の検証
- マイグレーションツールの開発

## 6. 成功基準

1. **信頼性**: 99.9%以上のメッセージ配信成功率
2. **パフォーマンス**: MCPと比較して許容範囲内のオーバーヘッド
3. **採用率**: 主要なMCP実装での採用
4. **エコシステム**: MCP-Txをサポートするツールやライブラリの登場

## 7. リスクと対策

### 7.1 技術的リスク
- **リスク**: 既存MCPとの互換性問題
- **対策**: 段階的な機能追加とオプトイン方式の採用

### 7.2 採用リスク
- **リスク**: コミュニティの採用が進まない
- **対策**: リファレンス実装の提供とドキュメンテーションの充実

## 8. MCPとの技術的連携

### 8.1 既存MCP機能の活用
- **Progress Notifications**: 長時間タスクの進捗通知とMCP-Txの統合
- **Cancellation**: MCPのキャンセル機能とRMCPのタイムアウト管理の連携
- **Error Handling**: MCPのエラーコード体系とRMCPのエラー分類の統合
- **Transport Layer**: MCPの既存トランスポート（stdio、WebSocket、HTTP）の拡張

### 8.2 実装指針
- **ラッパーアプローチ**: 既存MCPセッションをラップしてRMCP機能を追加
- **適応的モード**: MCPの機能を最大限活用し、不足する部分のみRMCPで補完
- **漸進的導入**: 既存システムへの影響を最小限にした段階的導入

### 8.3 Python SDK統合戦略
- **BaseSession拡張**: MCPの`BaseSession`クラスを継承したRMCPSessionの実装
- **Transport Integration**: 既存のstdio、WebSocketトランスポートの拡張
- **Error Mapping**: MCPエラーとRMCPエラーのマッピング体系
- **Backward Compatibility**: 既存MCPクライアント/サーバーとの完全互換性

## 9. 今後の展開

1. **MCPコミュニティとの連携**: 標準化プロセスへの参加
2. **公式SDKへの統合**: Python SDKや他言語SDKへのRMCPサポート追加
3. **エコシステム構築**: RMCP対応ツール、ミドルウェアの開発
4. **A2Aとの統合**: Agent間通信での信頼性保証への拡張
5. **クラウドネイティブ対応**: Kubernetes Operator、サービスメッシュ統合
6. **観測可能性の強化**: OpenTelemetry統合、分散トレーシング対応

---

**作成日**: 2025-01-19  
**更新日**: 2025-01-19  
**バージョン**: 1.1  
**ステータス**: レビュー済み

---

## 日本語要約

### プロジェクト概要
MCP-Txは、MCPの上位レイヤーとしてツール呼び出しに信頼性保証を追加するプロトコル拡張。MCPの現状調査により、自動再送・接続管理・冪等性保証・ACK/NACK機構が未実装であることを確認。

### 主要機能要件
- **FR-001**: 冪等性保証 - 重複実行防止とリクエストID管理
- **FR-002**: ACK/NACK - 明示的な確認応答機能
- **FR-003**: 自動再送制御 - 指数バックオフ対応
- **FR-004**: トランザクション管理 - UUID形式のID生成と状態追跡
- **FR-005**: フロー制御 - トークン数・API制限対応
- **FR-006**: 状態レポート - 最終ステータスと実行履歴
- **FR-007**: エラー処理 - 体系的なエラー分類とリカバリー
- **FR-008**: ヘルスチェック - システム健全性監視

### MCP統合戦略
- `experimental`フィールドでの機能ネゴシエーション
- `_meta`フィールドでのRMCPメタデータ埋め込み
- BaseSessionラッパーによる透過的な統合
- 完全な後方互換性維持

### 非機能要件
- パフォーマンス: +10%以内のオーバーヘッド
- 信頼性: 99.9%可用性
- 大ファイル: チャンク転送対応（10MB以上）
- セキュリティ: TLS 1.3、監査ログ生成